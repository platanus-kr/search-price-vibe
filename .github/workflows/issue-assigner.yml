name: Issue Auto Assigner

on:
  issues:
    types: [opened, reopened]

jobs:
  assign-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - name: Auto Assign Issue
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const issue = context.payload.issue;
          const author = issue.user.login;
          
          // íŒ€ ë©¤ë²„ ë° ì „ë¬¸ ë¶„ì•¼ (ì‹¤ì œ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”)
          const teamMembers = {
            'project-manager': ['general', 'planning', 'coordination'],
            'tech-lead': ['architecture', 'technical', 'review'],
            'backend-dev': ['backend', 'api', 'database', 'server'],
            'frontend-dev': ['frontend', 'ui', 'ux', 'client'],
            'qa-engineer': ['testing', 'quality', 'bug'],
            'devops-engineer': ['deployment', 'infrastructure', 'ci/cd', 'docker']
          };
          
          // ì´ìŠˆ ë‚´ìš© ë¶„ì„
          const title = issue.title.toLowerCase();
          const body = (issue.body || '').toLowerCase();
          const fullText = title + ' ' + body;
          
          let assignees = [];
          let assignmentReason = '';
          
          // ì´ìŠˆ íƒ€ì…ë³„ ìë™ í• ë‹¹ ë¡œì§
          if (title.includes('[bug]') || title.includes('bug') || fullText.includes('error') || fullText.includes('ë¬¸ì œ')) {
            // ë²„ê·¸ëŠ” QA ì—”ì§€ë‹ˆì–´ì—ê²Œ ìš°ì„  í• ë‹¹
            if (teamMembers['qa-engineer']) {
              assignees.push('qa-engineer');
              assignmentReason = 'ğŸ› ë²„ê·¸ ë¦¬í¬íŠ¸ë¡œ ë¶„ë¥˜ë˜ì–´ QA ì—”ì§€ë‹ˆì–´ì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
            // ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨ ë²„ê·¸ì¸ì§€ í™•ì¸
            if (fullText.includes('backend') || fullText.includes('api') || fullText.includes('server') || fullText.includes('database')) {
              if (teamMembers['backend-dev'] && !assignees.includes('backend-dev')) {
                assignees.push('backend-dev');
                assignmentReason += ' ë°±ì—”ë“œ ê´€ë ¨ ì´ìŠˆë¡œ ë°±ì—”ë“œ ê°œë°œìë„ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
              }
            }
            
            if (fullText.includes('frontend') || fullText.includes('ui') || fullText.includes('client') || fullText.includes('ë¸Œë¼ìš°ì €')) {
              if (teamMembers['frontend-dev'] && !assignees.includes('frontend-dev')) {
                assignees.push('frontend-dev');
                assignmentReason += ' í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨ ì´ìŠˆë¡œ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìë„ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
              }
            }
            
          } else if (title.includes('[feature]') || title.includes('feature') || fullText.includes('ê¸°ëŠ¥') || fullText.includes('ì¶”ê°€')) {
            // ê¸°ëŠ¥ ìš”ì²­ì€ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì—ê²Œ ìš°ì„  í• ë‹¹
            if (teamMembers['project-manager']) {
              assignees.push('project-manager');
              assignmentReason = 'ğŸš€ ê¸°ëŠ¥ ìš”ì²­ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
            // ê¸°ìˆ ì  ê²€í† ê°€ í•„ìš”í•œ ê²½ìš° ê¸°ìˆ  ë¦¬ë“œë„ í• ë‹¹
            if (fullText.includes('architecture') || fullText.includes('ê¸°ìˆ ') || fullText.includes('ì„¤ê³„')) {
              if (teamMembers['tech-lead'] && !assignees.includes('tech-lead')) {
                assignees.push('tech-lead');
                assignmentReason += ' ê¸°ìˆ ì  ê²€í† ê°€ í•„ìš”í•˜ì—¬ ê¸°ìˆ  ë¦¬ë“œë„ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
              }
            }
            
          } else if (title.includes('[question]') || title.includes('question') || fullText.includes('ì§ˆë¬¸') || fullText.includes('ì–´ë–»ê²Œ')) {
            // ì§ˆë¬¸ì€ ê¸°ìˆ  ë¦¬ë“œì—ê²Œ ìš°ì„  í• ë‹¹
            if (teamMembers['tech-lead']) {
              assignees.push('tech-lead');
              assignmentReason = 'â“ ì§ˆë¬¸ìœ¼ë¡œ ë¶„ë¥˜ë˜ì–´ ê¸°ìˆ  ë¦¬ë“œì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
          } else if (title.includes('[docs]') || title.includes('documentation') || fullText.includes('ë¬¸ì„œ')) {
            // ë¬¸ì„œ ê´€ë ¨ì€ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì—ê²Œ í• ë‹¹
            if (teamMembers['project-manager']) {
              assignees.push('project-manager');
              assignmentReason = 'ğŸ“š ë¬¸ì„œ ê´€ë ¨ ì´ìŠˆë¡œ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
          } else if (fullText.includes('deploy') || fullText.includes('ci/cd') || fullText.includes('infrastructure') || fullText.includes('ë°°í¬')) {
            // DevOps ê´€ë ¨ ì´ìŠˆ
            if (teamMembers['devops-engineer']) {
              assignees.push('devops-engineer');
              assignmentReason = 'ğŸš€ DevOps ê´€ë ¨ ì´ìŠˆë¡œ DevOps ì—”ì§€ë‹ˆì–´ì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
            
          } else {
            // ê¸°ë³¸ì ìœ¼ë¡œ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì—ê²Œ í• ë‹¹
            if (teamMembers['project-manager']) {
              assignees.push('project-manager');
              assignmentReason = 'ğŸ“‹ ì¼ë°˜ ì´ìŠˆë¡œ í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
          }
          
          // ìš°ì„ ìˆœìœ„ ë†’ì€ ì´ìŠˆëŠ” ê¸°ìˆ  ë¦¬ë“œë„ ì¶”ê°€ í• ë‹¹
          if (fullText.includes('urgent') || fullText.includes('critical') || fullText.includes('ê¸´ê¸‰') || fullText.includes('ì‹¬ê°')) {
            if (teamMembers['tech-lead'] && !assignees.includes('tech-lead')) {
              assignees.push('tech-lead');
              assignmentReason += ' ë†’ì€ ìš°ì„ ìˆœìœ„ë¡œ ê¸°ìˆ  ë¦¬ë“œë„ ì¶”ê°€ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.';
            }
          }
          
          // ì´ìŠˆ ì‘ì„±ìê°€ íŒ€ ë©¤ë²„ì¸ ê²½ìš° ë³¸ì¸ë„ í• ë‹¹
          const allMembers = Object.keys(teamMembers);
          if (allMembers.includes(author) && !assignees.includes(author)) {
            assignees.push(author);
          }
          
          try {
            // ë‹´ë‹¹ì í• ë‹¹
            if (assignees.length > 0) {
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: number,
                assignees: assignees
              });
              
              console.log(`ì´ìŠˆ #${number}ì— ë‹´ë‹¹ì í• ë‹¹ë¨: ${assignees.join(', ')}`);
              
              // í• ë‹¹ ê²°ê³¼ ëŒ“ê¸€ ì¶”ê°€
              const comment = `ğŸ‘¤ **ìë™ ë‹´ë‹¹ì í• ë‹¹ ì™„ë£Œ**
              
              **í• ë‹¹ëœ ë‹´ë‹¹ì:** ${assignees.map(assignee => `@${assignee}`).join(', ')}
              
              **í• ë‹¹ ì‚¬ìœ :** ${assignmentReason}
              
              **ë‹¤ìŒ ë‹¨ê³„:**
              1. ë‹´ë‹¹ìê°€ ì´ìŠˆë¥¼ ê²€í† í•©ë‹ˆë‹¤
              2. í•„ìš”ì‹œ ì¶”ê°€ ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤
              3. ì‘ì—… ì¼ì •ì„ ìˆ˜ë¦½í•˜ê³  ì•Œë ¤ë“œë¦½ë‹ˆë‹¤
              
              ë‹´ë‹¹ì ë³€ê²½ì´ í•„ìš”í•˜ì‹œë©´ ëŒ“ê¸€ë¡œ ì•Œë ¤ì£¼ì„¸ìš”! ğŸ”„`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: comment
              });
              
            } else {
              // í• ë‹¹í•  ë‹´ë‹¹ìê°€ ì—†ëŠ” ê²½ìš°
              const comment = `âš ï¸ **ìë™ í• ë‹¹ ì‹¤íŒ¨**
              
              ì ì ˆí•œ ë‹´ë‹¹ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í”„ë¡œì íŠ¸ ë§¤ë‹ˆì €ê°€ ìˆ˜ë™ìœ¼ë¡œ ë‹´ë‹¹ìë¥¼ í• ë‹¹í•  ì˜ˆì •ì…ë‹ˆë‹¤.
              
              ë” ì •í™•í•œ í• ë‹¹ì„ ìœ„í•´ ì´ìŠˆ ì œëª©ì— ë‹¤ìŒê³¼ ê°™ì€ íƒœê·¸ë¥¼ í¬í•¨í•´ì£¼ì„¸ìš”:
              - \`[Bug]\`: ë²„ê·¸ ì‹ ê³ 
              - \`[Feature]\`: ê¸°ëŠ¥ ìš”ì²­
              - \`[Question]\`: ì§ˆë¬¸
              - \`[Docs]\`: ë¬¸ì„œ ê´€ë ¨`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: comment
              });
            }
            
          } catch (error) {
            console.error('ì´ìŠˆ í• ë‹¹ ì¤‘ ì˜¤ë¥˜:', error);
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: `âš ï¸ ìë™ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë‹´ë‹¹ìë¥¼ í• ë‹¹í•´ ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ${error.message}`
            });
          } 