name: PR Auto Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Auto Code Review
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo, number } = context.pullRequest;
          
          // PR íŒŒì¼ ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
          const { data: files } = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: number
          });
          
          let reviewComments = [];
          let generalComments = [];
          
          // ì½”ë“œ í’ˆì§ˆ ì²´í¬
          for (const file of files) {
            const filename = file.filename;
            const patch = file.patch || '';
            
            // Python íŒŒì¼ ì²´í¬
            if (filename.endsWith('.py')) {
              // ê¸´ ë¼ì¸ ì²´í¬
              const lines = patch.split('\n');
              lines.forEach((line, index) => {
                if (line.startsWith('+') && line.length > 120) {
                  reviewComments.push({
                    path: filename,
                    line: index + 1,
                    body: 'âš ï¸ ì´ ë¼ì¸ì´ 120ìë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤. ê°€ë…ì„±ì„ ìœ„í•´ ì¤„ë°”ê¿ˆì„ ê³ ë ¤í•´ë³´ì„¸ìš”.'
                  });
                }
                
                // TODO, FIXME ë“± ì²´í¬
                if (line.includes('TODO') || line.includes('FIXME') || line.includes('HACK')) {
                  reviewComments.push({
                    path: filename,
                    line: index + 1,
                    body: 'ğŸ“ TODO/FIXMEê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìŠˆë¥¼ ìƒì„±í•˜ì—¬ ì¶”ì í•˜ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.'
                  });
                }
                
                // print ë¬¸ ì²´í¬ (ë””ë²„ê¹… ì½”ë“œì¼ ê°€ëŠ¥ì„±)
                if (line.includes('print(') && !filename.includes('test')) {
                  reviewComments.push({
                    path: filename,
                    line: index + 1,
                    body: 'ğŸ› printë¬¸ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê¹… ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©ì„ ê³ ë ¤í•´ë³´ì„¸ìš”.'
                  });
                }
              });
              
              // í…ŒìŠ¤íŠ¸ íŒŒì¼ ì²´í¬
              if (filename.includes('test') && file.additions > 0) {
                generalComments.push('âœ… í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. ì¢‹ìŠµë‹ˆë‹¤!');
              }
            }
            
            // ì„¤ì • íŒŒì¼ ë³€ê²½ ì²´í¬
            if (filename === 'requirements.txt' || filename.includes('requirements')) {
              generalComments.push('ğŸ“¦ ì˜ì¡´ì„±ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ íŒ¨í‚¤ì§€ê°€ í•„ìš”í•œ ì´ìœ ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”.');
            }
            
            // í° íŒŒì¼ ë³€ê²½ ì²´í¬
            if (file.changes > 200) {
              generalComments.push(`ğŸ“„ ${filename} íŒŒì¼ì— ë§ì€ ë³€ê²½ì‚¬í•­(${file.changes}ì¤„)ì´ ìˆìŠµë‹ˆë‹¤. ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.`);
            }
          }
          
          // ì „ì²´ ë³€ê²½ì‚¬í•­ ë¶„ì„
          const totalChanges = files.reduce((sum, file) => sum + file.changes, 0);
          const addedLines = files.reduce((sum, file) => sum + file.additions, 0);
          const deletedLines = files.reduce((sum, file) => sum + file.deletions, 0);
          
          // í° PR ê²½ê³ 
          if (totalChanges > 500) {
            generalComments.push('ğŸš¨ ì´ PRì€ ë§¤ìš° í½ë‹ˆë‹¤ (500ì¤„ ì´ìƒ). ë¦¬ë·°ì–´ì˜ ë¶€ë‹´ì„ ì¤„ì´ê¸° ìœ„í•´ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì„ ê³ ë ¤í•´ë³´ì„¸ìš”.');
          }
          
          // ì‚­ì œë§Œ ìˆëŠ” ê²½ìš°
          if (addedLines === 0 && deletedLines > 0) {
            generalComments.push('ğŸ§¹ ì½”ë“œ ì •ë¦¬ ì‘ì—…ì´êµ°ìš”! ì‚­ì œëœ ì½”ë“œê°€ ë‹¤ë¥¸ ê³³ì—ì„œ ì‚¬ìš©ë˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸í–ˆëŠ”ì§€ ì•Œë ¤ì£¼ì„¸ìš”.');
          }
          
          // ë¦¬ë·° ìƒì„±
          let reviewBody = 'ğŸ¤– **ìë™ ì½”ë“œ ë¦¬ë·°**\n\n';
          
          // í†µê³„ ì •ë³´
          reviewBody += `**ğŸ“Š ë³€ê²½ í†µê³„:**\n`;
          reviewBody += `- ë³€ê²½ëœ íŒŒì¼: ${files.length}ê°œ\n`;
          reviewBody += `- ì¶”ê°€ëœ ì¤„: ${addedLines}ì¤„\n`;
          reviewBody += `- ì‚­ì œëœ ì¤„: ${deletedLines}ì¤„\n`;
          reviewBody += `- ì´ ë³€ê²½ëŸ‰: ${totalChanges}ì¤„\n\n`;
          
          // ì¼ë°˜ ì½”ë©˜íŠ¸
          if (generalComments.length > 0) {
            reviewBody += '**ğŸ’¡ ì¼ë°˜ ì œì•ˆì‚¬í•­:**\n';
            generalComments.forEach(comment => {
              reviewBody += `- ${comment}\n`;
            });
            reviewBody += '\n';
          }
          
          // ì²´í¬ë¦¬ìŠ¤íŠ¸
          reviewBody += '**âœ… ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸:**\n';
          reviewBody += '- [ ] ì½”ë“œê°€ ì½ê¸° ì‰½ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ê°€?\n';
          reviewBody += '- [ ] ë³€ìˆ˜ëª…ê³¼ í•¨ìˆ˜ëª…ì´ ëª…í™•í•œê°€?\n';
          reviewBody += '- [ ] ì—ëŸ¬ ì²˜ë¦¬ê°€ ì ì ˆíˆ ë˜ì–´ ìˆëŠ”ê°€?\n';
          reviewBody += '- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œê°€ ì¶©ë¶„í•œê°€?\n';
          reviewBody += '- [ ] ì„±ëŠ¥ìƒ ë¬¸ì œëŠ” ì—†ëŠ”ê°€?\n';
          reviewBody += '- [ ] ë³´ì•ˆìƒ ì·¨ì•½ì ì€ ì—†ëŠ”ê°€?\n';
          reviewBody += '- [ ] ë¬¸ì„œí™”ê°€ í•„ìš”í•œ ë¶€ë¶„ì€ ì—†ëŠ”ê°€?\n\n';
          
          reviewBody += 'ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ë¦¬ë·°ëŠ” íŒ€ ë©¤ë²„ê°€ ì§„í–‰í•  ì˜ˆì •ì…ë‹ˆë‹¤. ğŸ‘¥';
          
          try {
            // ì¼ë°˜ ëŒ“ê¸€ë¡œ ë¦¬ë·° ê²°ê³¼ ê²Œì‹œ
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: reviewBody
            });
            
            // ë¼ì¸ ë‹¨ìœ„ ì½”ë©˜íŠ¸ê°€ ìˆë‹¤ë©´ ë¦¬ë·°ë¡œ ë“±ë¡
            if (reviewComments.length > 0) {
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: number
              });
              
              await github.rest.pulls.createReview({
                owner,
                repo,
                pull_number: number,
                commit_id: pr.head.sha,
                body: 'ğŸ¤– ìë™ ì½”ë“œ ë¦¬ë·°ì—ì„œ ë°œê²¬ëœ ê°œì„ ì‚¬í•­ë“¤ì…ë‹ˆë‹¤.',
                event: 'COMMENT',
                comments: reviewComments.slice(0, 10) // ìµœëŒ€ 10ê°œ ì½”ë©˜íŠ¸ë§Œ
              });
            }
            
            console.log('ìë™ ë¦¬ë·° ì™„ë£Œ');
            
          } catch (error) {
            console.error('ìë™ ë¦¬ë·° ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
          } 