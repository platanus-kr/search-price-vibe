name: Issue Auto Labeler

on:
  issues:
    types: [opened, reopened, edited]

jobs:
  label-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
    - name: Auto Label Issue
      uses: actions/github-script@v6
      with:
        script: |
          const { owner, repo, number } = context.issue;
          const issue = context.payload.issue;
          
          // ì´ìŠˆ ë‚´ìš© ë¶„ì„
          const title = issue.title.toLowerCase();
          const body = (issue.body || '').toLowerCase();
          const fullText = title + ' ' + body;
          
          let labels = [];
          
          // íƒ€ì… ë¼ë²¨ (ìš°ì„ ìˆœìœ„: ì œëª© > ë‚´ìš©)
          if (title.includes('[bug]') || title.includes('bug') || fullText.includes('error') || fullText.includes('ë¬¸ì œ') || fullText.includes('ì˜¤ë¥˜')) {
            labels.push('type/bug');
          } else if (title.includes('[feature]') || title.includes('feature') || fullText.includes('ê¸°ëŠ¥') || fullText.includes('ì¶”ê°€') || fullText.includes('ê°œì„ ')) {
            labels.push('type/feature');
          } else if (title.includes('[enhancement]') || title.includes('enhancement') || fullText.includes('í–¥ìƒ') || fullText.includes('ê°œì„ ')) {
            labels.push('type/enhancement');
          } else if (title.includes('[question]') || title.includes('question') || fullText.includes('ì§ˆë¬¸') || fullText.includes('ì–´ë–»ê²Œ') || fullText.includes('ë„ì›€')) {
            labels.push('type/question');
          } else if (title.includes('[docs]') || title.includes('documentation') || fullText.includes('ë¬¸ì„œ') || fullText.includes('readme')) {
            labels.push('type/documentation');
          } else if (title.includes('[task]') || title.includes('task') || fullText.includes('ì‘ì—…') || fullText.includes('í• ì¼')) {
            labels.push('type/task');
          }
          
          // ìš°ì„ ìˆœìœ„ ë¼ë²¨
          if (fullText.includes('critical') || fullText.includes('urgent') || fullText.includes('ì‹¬ê°') || fullText.includes('ê¸´ê¸‰') || fullText.includes('ì¹˜ëª…ì ')) {
            labels.push('priority/critical');
          } else if (fullText.includes('high') || fullText.includes('important') || fullText.includes('ë†’ìŒ') || fullText.includes('ì¤‘ìš”')) {
            labels.push('priority/high');
          } else if (fullText.includes('low') || fullText.includes('minor') || fullText.includes('ë‚®ìŒ') || fullText.includes('ê²½ë¯¸')) {
            labels.push('priority/low');
          } else {
            labels.push('priority/medium');
          }
          
          // ì˜ì—­ ë¼ë²¨
          if (fullText.includes('backend') || fullText.includes('api') || fullText.includes('server') || fullText.includes('ë°±ì—”ë“œ') || fullText.includes('ì„œë²„')) {
            labels.push('area/backend');
          }
          
          if (fullText.includes('frontend') || fullText.includes('ui') || fullText.includes('client') || fullText.includes('í”„ë¡ íŠ¸ì—”ë“œ') || fullText.includes('í™”ë©´') || fullText.includes('ì¸í„°í˜ì´ìŠ¤')) {
            labels.push('area/frontend');
          }
          
          if (fullText.includes('database') || fullText.includes('db') || fullText.includes('ë°ì´í„°ë² ì´ìŠ¤') || fullText.includes('ë°ì´í„°')) {
            labels.push('area/database');
          }
          
          if (fullText.includes('test') || fullText.includes('testing') || fullText.includes('í…ŒìŠ¤íŠ¸') || fullText.includes('ê²€ì¦')) {
            labels.push('area/testing');
          }
          
          if (fullText.includes('deploy') || fullText.includes('ci/cd') || fullText.includes('infrastructure') || fullText.includes('ë°°í¬') || fullText.includes('ì¸í”„ë¼')) {
            labels.push('area/devops');
          }
          
          if (fullText.includes('security') || fullText.includes('ë³´ì•ˆ') || fullText.includes('ê¶Œí•œ') || fullText.includes('ì¸ì¦')) {
            labels.push('area/security');
          }
          
          if (fullText.includes('performance') || fullText.includes('slow') || fullText.includes('ì„±ëŠ¥') || fullText.includes('ëŠë¦¼') || fullText.includes('ì†ë„')) {
            labels.push('area/performance');
          }
          
          // ìƒíƒœ ë¼ë²¨
          labels.push('status/open');
          
          // íŠ¹ë³„í•œ ìƒí™© ë¼ë²¨
          if (fullText.includes('breaking') || fullText.includes('breaking change') || fullText.includes('í˜¸í™˜ì„±') || fullText.includes('ë³€ê²½ì‚¬í•­')) {
            labels.push('breaking-change');
          }
          
          if (fullText.includes('duplicate') || fullText.includes('ì¤‘ë³µ')) {
            labels.push('duplicate');
          }
          
          if (fullText.includes('help wanted') || fullText.includes('ë„ì›€ í•„ìš”') || fullText.includes('ê¸°ì—¬')) {
            labels.push('help wanted');
          }
          
          if (fullText.includes('good first issue') || fullText.includes('ì²˜ìŒ') || fullText.includes('ì´ˆë³´ì')) {
            labels.push('good first issue');
          }
          
          if (fullText.includes('wontfix') || fullText.includes('ìˆ˜ì • ì•ˆí•¨') || fullText.includes('ì˜ë„ëœ')) {
            labels.push('wontfix');
          }
          
          // ë³µì¡ë„ ë¼ë²¨ (ë‹¨ì–´ ìˆ˜ì™€ í‚¤ì›Œë“œë¡œ ì¶”ì •)
          const wordCount = fullText.split(' ').length;
          const hasComplexKeywords = fullText.includes('architecture') || fullText.includes('refactor') || fullText.includes('migration') || fullText.includes('ì„¤ê³„') || fullText.includes('ë¦¬íŒ©í† ë§');
          
          if (wordCount > 100 || hasComplexKeywords) {
            labels.push('complexity/high');
          } else if (wordCount > 50) {
            labels.push('complexity/medium');
          } else {
            labels.push('complexity/low');
          }
          
          // ì‹œê°„ ì¶”ì • ë¼ë²¨
          if (fullText.includes('quick') || fullText.includes('simple') || fullText.includes('ê°„ë‹¨') || fullText.includes('ë¹ ë¥¸')) {
            labels.push('effort/1-day');
          } else if (fullText.includes('week') || fullText.includes('ì£¼') || hasComplexKeywords) {
            labels.push('effort/1-week');
          } else {
            labels.push('effort/few-days');
          }
          
          // ì¤‘ë³µ ì œê±°
          labels = [...new Set(labels)];
          
          try {
            // ê¸°ì¡´ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
            const { data: currentIssue } = await github.rest.issues.get({
              owner,
              repo,
              issue_number: number
            });
            
            const currentLabels = currentIssue.labels.map(label => label.name);
            const newLabels = labels.filter(label => !currentLabels.includes(label));
            
            // ìƒˆë¡œìš´ ë¼ë²¨ë§Œ ì¶”ê°€
            if (newLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: number,
                labels: newLabels
              });
              
              console.log(`ì´ìŠˆ #${number}ì— ë¼ë²¨ ì¶”ê°€ë¨: ${newLabels.join(', ')}`);
              
              // ë¼ë²¨ ì¶”ê°€ ê²°ê³¼ ëŒ“ê¸€
              const comment = `ğŸ·ï¸ **ìë™ ë¼ë²¨ë§ ì™„ë£Œ**
              
              **ìƒˆë¡œ ì¶”ê°€ëœ ë¼ë²¨:**
              ${newLabels.map(label => `- \`${label}\``).join('\n')}
              
              **ğŸ“Š ì´ìŠˆ ë¶„ì„ ê²°ê³¼:**
              - ì˜ˆìƒ ë³µì¡ë„: ${labels.find(l => l.startsWith('complexity/'))?.replace('complexity/', '') || 'ë¯¸ë¶„ë¥˜'}
              - ì˜ˆìƒ ì‘ì—… ì‹œê°„: ${labels.find(l => l.startsWith('effort/'))?.replace('effort/', '') || 'ë¯¸ë¶„ë¥˜'}
              - ìš°ì„ ìˆœìœ„: ${labels.find(l => l.startsWith('priority/'))?.replace('priority/', '') || 'ë¯¸ë¶„ë¥˜'}
              
              **ğŸ¯ ê´€ë ¨ ì˜ì—­:**
              ${labels.filter(l => l.startsWith('area/')).map(l => `- ${l.replace('area/', '')}`).join('\n') || '- ì¼ë°˜'}
              
              ë¼ë²¨ì´ ë¶€ì •í™•í•˜ë‹¤ë©´ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”! âœï¸`;
              
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: number,
                body: comment
              });
            } else {
              console.log(`ì´ìŠˆ #${number}: ì¶”ê°€í•  ìƒˆë¡œìš´ ë¼ë²¨ì´ ì—†ìŠµë‹ˆë‹¤.`);
            }
            
          } catch (error) {
            console.error('ì´ìŠˆ ë¼ë²¨ë§ ì¤‘ ì˜¤ë¥˜:', error);
            
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: `âš ï¸ ìë™ ë¼ë²¨ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë¼ë²¨ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.\n\nì˜¤ë¥˜: ${error.message}`
            });
          } 